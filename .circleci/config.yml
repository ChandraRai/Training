workflows:
  version: 2
  test_build:
      jobs:
        - test
        - dockerize:
            requires:
              - test
        - deploy:
            requires:
              - dockerize

jobs:
  test:
    docker:   
    - image: chandrarai/pythonapp:latest
    working_directory: ~/chandra
    steps:
    - add_ssh_keys:
           fingerprints:
           - "58:a2:74:6c:1d:17:85:32:61:46:9f:14:68:a6:8f:6d"
      - checkout
             
      - store_artifacts:
           path: .
           destination: test_output
             
  dockerize:
    machine: true
    steps:
      - checkout
      # Login to docker
      - run: docker login -u $DOCKER_USER -p $DOCKER_PASS

      # build the application image
      - run: docker build -t $DOCKER_USER/cir_chandra:$CIRCLE_SHA1 .
     
      - checkout

      # deploy the image to dockerhub
      - run: docker push $DOCKER_USER/cir_chandra:$CIRCLE_SHA1
   
  deploy:
    machine: true
    steps:
      - checkout

      - run: docker pull chandrarai/cir_chandra:$CIRCLE_SHA1    

      - run: docker run -p 8080:8080 --name cir_chandra chandrarai/cir_chandra:$CIRCLE_SHA1  

      #- run: ssh -p 64625 ubuntu@54.221.135.43 -L 8080:localhost:8080

      - run: echo "Hello World"

